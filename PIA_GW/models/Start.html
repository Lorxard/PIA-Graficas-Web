<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proyecto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="../Pausa.css">
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="mainNav" class ="menu_bot" hidden = "true">
      <nav class="main-nav">
          <ul class ="main-nav-list">
              
              <li class="main-nav-item">
                  <a class="main-nav-link" id="botonpausa">
                      Pausa
                  </a>

              </li>
          </br> </br>
          </ul>

          <ul class ="main-nav-list">
              
              <li class="main-nav-item" >
                  <a class="main-nav-link" href="../index.html">
                      Volver al Menu
                  </a>

              </li>
          </br> </br>
          </ul>

      </nav>
    </div>
    <div id="gameOver" class ="menu_bot" hidden = "true">
      <nav class="main-nav">
          <ul class ="main-nav-list">
              
              <li class="main-nav-item" >
                  <a class="main-nav-link" id="gameovertext">
                      GAME OVER
                  </a>

              </li>
          </br> </br>
          </ul>

          <ul class ="main-nav-list">
              
            <li class="main-nav-item" >
                <a class="main-nav-link" id="puntajefinal">
                    Puntaje
                </a>

            </li>
          </br> </br>
          </ul>

          <ul class ="main-nav-list">
              
              <li class="main-nav-item">
                  <a class="main-nav-link" href="../index.html">
                      Volver al Menu
                  </a>

              </li>
          </br> </br>
          </ul>

      </nav>
    </div>
    <div style="overflow: hidden; width: 100%; height: 100%; position: absolute; top: 0px; pointer-events: none;" id="hud"></div>
    <script type="module">
      import * as THREE from "./three.module.js";
      import { OrbitControls } from "./OrbitControls.js";
      import { GLTFLoader } from "./GLTFLoader.js";
      //import {FBXLoader } from './FBXLoader.js';
      import {FBXLoader} from 'https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/FBXLoader.js';
      import { STLLoader } from "./STLLoader.js";
      import Timer from "./timer.js";

      var scene, camera, renderer, hud;
      var audioLoader, disparoLoader, listener, backgroundSound, gunshotSound;
      var meshFloor;


      var vidahud, timerhud, enemigoshud, estatushud, estatushud2, municionhud, vidahud;

      var keyboard = {};
      var player = {speed: 0.5, turnspeed: 0.02, model: null, bb: null, canShoot: 0, bullets: [], bulletscoll: [], ammo:10 , life: 100, points: 0, enemigos: 0};
      var pause = false;
      var gameover = false;
      var victoria = false;

      

      var models = {
        casa : {
          glb: "House.glb",
          mesh: null
        },
        bank : {
          glb: "bank_from_old_west.glb",
          mesh: null
        },
        casa2 : {
          glb: "House2.glb",
          mesh: null
        },
        cactus : {
          glb: "Cactus.glb",
          mesh: null
        },
        cactus2 : {
          glb: "Cactus2.glb",
          mesh: null
        },
        saloon : {
          glb: "west_building-freepoly.org.glb",
          mesh: null
        },
        zombie : {
          glb: "Zombie.glb",
          mesh: null
        },
        caja : {
          glb: "wooden_box_free.glb",
          mesh: null
        },
        carro:{
          glb:"carro.glb",
          mesh: null
        }
      }
      var meshes = {};
      var items= {};

      var zombies= {};

      var tempo = new Timer(60);

      var loadingScreen = {
        scene: new THREE.Scene(),
        camera: new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight, 1, 100
        ),
        box: new THREE.Mesh(
	  	    new THREE.BoxGeometry(0.5,0.5,0.5),
		      new THREE.MeshBasicMaterial({ color:0x4444ff })
	      )
      };
      var loadingManager = null;
      var RESOURCES_LOADED = false;
      
      function init(){
        
        // SCENE
        scene = new THREE.Scene();
        scene.background = new THREE.Color("#34495E");
        //scene.fog = new THREE.Fog(0x404040,0,500)

        camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight, 1, 1000
        );
        camera.rotation.y = Math.PI * .5;
        camera.position.set(80, 5, 0);

        hud = document.getElementById("hud");
        const div = document.createElement("div");
        div.setAttribute("class", "row m-1");
        hud.appendChild(div);
        timerhud = document.createElement("div");
        timerhud.setAttribute("id", "timerhud");
        timerhud.setAttribute("class", "col-3");
        vidahud = document.createElement("div");
        vidahud.setAttribute("id", "vidahud");
        vidahud.setAttribute("class", "col-3");
        municionhud = document.createElement("div");
        municionhud.setAttribute("id", "municionhud");
        municionhud.setAttribute("class", "col-3");
        enemigoshud = document.createElement("div");
        enemigoshud.setAttribute("id", "enemigoshud");
        enemigoshud.setAttribute("class", "col-3");
        estatushud = document.createElement("div");
        estatushud.setAttribute("id", "estatushud");
        estatushud.setAttribute("class", " m-1");
        estatushud2 = document.createElement("div");
        estatushud2.setAttribute("id", "estatushud2");
        estatushud2.setAttribute("class", " m-1");

        
        div.appendChild(timerhud);
        div.appendChild(vidahud);
        div.appendChild(municionhud);
        div.appendChild(enemigoshud);
        hud.appendChild(estatushud);
        hud.appendChild(estatushud2);

        listener = new THREE.AudioListener();
        camera.add(listener);

        audioLoader = new THREE.AudioLoader();
        disparoLoader = new THREE.AudioLoader();

        backgroundSound = new THREE.Audio(listener);
        gunshotSound = new THREE.Audio(listener);

        audioLoader.load('./audios/desierto.mp3', function(buffer){
          backgroundSound.setBuffer(buffer);
          backgroundSound.setLoop(true);
          backgroundSound.setVolume(.2);
        });
        disparoLoader.load('./audios/disparo.mp3', function(buffer){
          gunshotSound.setBuffer(buffer);
          gunshotSound.setLoop(false);
          gunshotSound.duration = .3;
          gunshotSound.setVolume(.2);
        });

        // Set up the loading screen's scene.
        // It can be treated just like our main scene.
        loadingScreen.box.position.set(0,0,5);
        loadingScreen.camera.lookAt(loadingScreen.box.position);
        loadingScreen.scene.add(loadingScreen.box);
        
        // Create a loading manager to set RESOURCES_LOADED when appropriate.
        // Pass loadingManager to all resource loaders.
        loadingManager = new THREE.LoadingManager();
        
        loadingManager.onProgress = function(item, loaded, total){
          console.log(item, loaded, total);
        };

        
        loadingManager.onLoad = function(){
          console.log("loaded all resources");
          RESOURCES_LOADED = true;
          onResourcesLoaded();
          tempo.start();
          backgroundSound.play();

        };

        const loader = new THREE.TextureLoader();
        loader.load("./Imagenes/blue_sky.jpg", function (texture) {
          scene.background = texture;
        });

        var texturaSky = new THREE.TextureLoader().load( "./Imagenes/dry_sky.jpg" );
        var meshSky = new THREE.Mesh(
          new THREE.SphereGeometry(500, 25, 25),
          new THREE.MeshPhongMaterial({ map: texturaSky })
        );
        meshSky.material.side= THREE.BackSide;

        
        scene.add(meshSky);

        // RENDERER
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lights
        const light = new THREE.AmbientLight( 0xffffff ); // soft white light
        scene.add( light );

        const directionalLight = new THREE.DirectionalLight(0xffffff, .1);
        directionalLight.position.set(0, 100, 50);
        directionalLight.castShadow = true;
        scene.add( directionalLight);


        // Plane
        var texture = new THREE.TextureLoader().load( "./Imagenes/tierra_seca.jpg" );
          texture.wrapS=THREE.RepeatWrapping;
          texture.wrapT=THREE.RepeatWrapping;
          texture.repeat.set( 20,20 );

          var textureD = new THREE.TextureLoader().load( "./Imagenes/tierra_seca_dis.png" );
          textureD.wrapS=THREE.RepeatWrapping;
          textureD.wrapT=THREE.RepeatWrapping;
          textureD.repeat.set( 20,20 );

          var textureN = new THREE.TextureLoader().load( "./Imagenes/tierra_seca_norm.jpg" );
          textureN.wrapS=THREE.RepeatWrapping;
          textureN.wrapT=THREE.RepeatWrapping;
          textureN.repeat.set( 20,20 );


        meshFloor = new THREE.Mesh(
          new THREE.PlaneGeometry(500, 300),
          new THREE.MeshStandardMaterial({ 
          map: texture,
          displacementMap: textureD,
          displacementScale: .6,
          normalMap: textureN
         })
        );
        
        meshFloor.position.set(15, -0.5, 15);
        meshFloor.receiveShadow = true;
        meshFloor.rotateX(-Math.PI / 2);

        // Adding to scene
        scene.add( meshFloor);

        //const cameraControl = new OrbitControls(camera, renderer.domElement);

        // Resize

        function resize() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.render(scene, camera);
        }
        window.addEventListener("resize", resize);

        modelos();
        animate();
      }

      function checkCollisions() {
        if(items["ammo1BB"].consumed == false){
          if(player.bb.intersectsBox(items.ammo1BB.coll)){
            scene.remove(items["ammo1BB"].item);
            items.ammo1BB.consumed = true;
            player.ammo +=10;
            console.log("encontraste municion, tienes: ", player.ammo);
            estatushud2.textContent = "Encontraste Municion!";
            setTimeout(function(){
              estatushud2.textContent = "";
            }, 2000);
          }
        }
        if(items["ammo2BB"].consumed == false){
          if(player.bb.intersectsBox(items.ammo2BB.coll)){
            scene.remove(items["ammo2BB"].item);
            items.ammo2BB.consumed = true;
            player.ammo +=10;
            console.log("encontraste municion, tienes: ", player.ammo);
            estatushud2.textContent = "Encontraste Municion!";
            setTimeout(function(){
              estatushud2.textContent = "";
            }, 2000);
          }
        }
        if(items["life1BB"].consumed == false){
          if(player.bb.intersectsBox(items.life1BB.coll)){
            scene.remove(items["life1BB"].item);
            items.life1BB.consumed = true;
            player.life +=30;
            if(player.life > 120) player.life = 120;
            console.log("encontraste un botiquin, la vida del jugador es: ", player.life);
            estatushud2.textContent = "Encontraste un botiquin, tu vida aumento 30 pts(120 pts max)!";
            setTimeout(function(){
              estatushud2.textContent = "";
            }, 2000);
          }
        }
        if(items["life2BB"].consumed == false){
          if(player.bb.intersectsBox(items.life2BB.coll)){
            scene.remove(items["life2BB"].item);
            items.life2BB.consumed = true;
            player.life +=30;
            if(player.life > 120) player.life = 120;
            console.log("encontraste un botiquin, la vida del jugador es: ", player.life);
            estatushud2.textContent = "Encontraste un botiquin, tu vida aumento 30 pts(120 pts max)!";
            setTimeout(function(){
              estatushud2.textContent = "";
            }, 2000);
          }
        }
        if(items["time1BB"].consumed == false){
          if(player.bb.intersectsBox(items.time1BB.coll)){
            scene.remove(items["time1BB"].item);
            items.time1BB.consumed = true;
            console.log("aumento el tiempo + 20seg");
            tempo.remainingSeconds = tempo.remainingSeconds + 20;
            estatushud2.textContent = "Tiempo extra, tienes 20 seg mas!";
            setTimeout(function(){
              estatushud2.textContent = "";
            }, 2000);
          }
        }
        if(items["bomba1BB"].consumed == false){
          if(player.bb.intersectsBox(items.bomba1BB.coll)){
            scene.remove(items["bomba1BB"].item);
            items.bomba1BB.consumed = true;
            player.life = player.life-50;
            console.log("te exploto una bomba, la vida del jugador es: ", player.life);
            estatushud2.textContent = "La caja tenia una bomba, perdiste 50 pts de vida!";
            setTimeout(function(){
              estatushud2.textContent = "";
            }, 2000);
          }
        }


        for(var index = 0; index <player.bulletscoll.length; index+=1){
          if(player.bulletscoll[index].intersectsBox(zombies["zombie1BB"].coll) && zombies["zombie1BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie1BB"].item);
            zombies["zombie1BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie2BB"].coll) && zombies["zombie2BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie2BB"].item);
            zombies["zombie2BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie3BB"].coll) && zombies["zombie3BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie3BB"].item);
            zombies["zombie3BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie4BB"].coll) && zombies["zombie4BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie4BB"].item);
            zombies["zombie4BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie5BB"].coll) && zombies["zombie5BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie5BB"].item);
            zombies["zombie5BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie6BB"].coll) && zombies["zombie6BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie6BB"].item);
            zombies["zombie6BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie7BB"].coll) && zombies["zombie7BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie7BB"].item);
            zombies["zombie7BB"].consumed = true;
            continue;
          };
          if(player.bulletscoll[index].intersectsBox(zombies["zombie8BB"].coll) && zombies["zombie8BB"].consumed == false) {
            player.enemigos += 1;
            console.log("zombies eliminados: ", player.enemigos);
            scene.remove(player.bullets[index]);
            player.bullets[index].alive = false;
            player.bulletscoll.splice(index,1);
            player.bullets.splice(index,1);
            scene.remove(zombies["zombie8BB"].item);
            zombies["zombie8BB"].consumed = true;
            continue;
          };

        }

      }

      function onResourcesLoaded(){
        meshes["casa.1"] = models.casa.mesh.clone();
        meshes["casa.1"].position.set(60, 0.02, 60);
        meshes["casa.1"].scale.set(1.7, 1.7, 1.7);
        scene.add(meshes["casa.1"]);
        meshes["casa.2"] = models.casa.mesh.clone();
        meshes["casa.2"].position.set(-70, 0.02, 60);
        meshes["casa.2"].scale.set(1.7, 1.7, 1.7);
        scene.add(meshes["casa.2"]);
        meshes["casa.3"] = models.casa.mesh.clone();
        meshes["casa.3"].rotation.y=300;
        meshes["casa.3"].position.set(-60, 0.02, -60);
        meshes["casa.3"].scale.set(1.7, 1.7, 1.7);
        scene.add(meshes["casa.3"]);

        meshes["bank.1"] = models.bank.mesh.clone();
        meshes["bank.1"].rotation.y=600;
        meshes["bank.1"].position.set(90, 2.02, -40);
        meshes["bank.1"].scale.set(3.9, 3.9, 3.9);
        scene.add(meshes["bank.1"]);
        meshes["bank.2"] = models.bank.mesh.clone();
        meshes["bank.2"].rotation.y=0;
        meshes["bank.2"].position.set(15, 2.02, 45);
        meshes["bank.2"].scale.set(3.9, 3.9, 3.9);
        scene.add(meshes["bank.2"]);
        meshes["bank.3"] = models.bank.mesh.clone();
        meshes["bank.3"].rotation.y=600;
        meshes["bank.3"].position.set(-110, 2.02, -40);
        meshes["bank.3"].scale.set(3.9, 3.9, 3.9);
        scene.add(meshes["bank.3"]);

        meshes["casa2.1"] = models.casa2.mesh.clone();
        meshes["casa2.1"].position.set(60, 0.02, -60);
        meshes["casa2.1"].scale.set(3.9, 3.9, 3.9);
        scene.add(meshes["casa2.1"]);
        meshes["casa2.2"] = models.casa2.mesh.clone();
        meshes["casa2.2"].position.set(-20, 0.02, -60);
        meshes["casa2.2"].scale.set(3.9, 3.9, 3.9);
        scene.add(meshes["casa2.2"]);

        meshes["saloon.1"] = models.saloon.mesh.clone();
        meshes["saloon.1"].rotation.y=600;
        meshes["saloon.1"].position.set(-10, 0.02, 60);
        meshes["saloon.1"].scale.set(3.9, 3.9, 3.9);
        scene.add(meshes["saloon.1"]);
        meshes["saloon.2"] = models.saloon.mesh.clone();
        meshes["saloon.2"].scale.set(3.9, 3.9, 3.9);
        meshes["saloon.2"].position.set (15, 0.02, -60);
        scene.add(meshes["saloon.2"]);

        meshes["cactus.1"] = models.cactus2.mesh.clone();
        meshes["cactus.1"].position.set(50, 0.02, -15);
        meshes["cactus.1"].scale.set(0.9, 0.9, 0.9);
        meshes["cactus.1"].rotation.set(0,2.79253,0);
        scene.add(meshes["cactus.1"]);

        meshes["cactus.2"] = models.cactus2.mesh.clone();
        meshes["cactus.2"].position.set(35, 0.02, 50);
        meshes["cactus.2"].scale.set(0.9, 0.9, 0.9);
        scene.add(meshes["cactus.2"]);

        meshes["cactus.3"] = models.cactus.mesh.clone();
        meshes["cactus.3"].position.set(-90, 0.02, 40);
        meshes["cactus.3"].scale.set(0.2, 0.2, 0.2);
        meshes["cactus.3"].rotation.set(0,2.79253,0);
        scene.add(meshes["cactus.3"]);

        meshes["cactus.4"] = models.cactus.mesh.clone();
        meshes["cactus.4"].position.set(-90, 0.02, -40);
        meshes["cactus.4"].scale.set(0.2, 0.2, 0.2);
        meshes["cactus.4"].rotation.set(0,2.,0);
        scene.add(meshes["cactus.4"]);

        meshes["cactus.5"] = models.cactus.mesh.clone();
        meshes["cactus.5"].position.set(-40, 0.02, -70);
        meshes["cactus.5"].scale.set(0.2, 0.2, 0.2);
        meshes["cactus.5"].rotation.set(0,2.,0);
        scene.add(meshes["cactus.5"]);

        meshes["cactus.6"] = models.cactus.mesh.clone();
        meshes["cactus.6"].position.set(80, 0.02, -20);
        meshes["cactus.6"].scale.set(0.2, 0.2, 0.2);
        meshes["cactus.6"].rotation.set(0,2.,0);
        scene.add(meshes["cactus.6"]);



        meshes["cactus2.1"] = models.cactus2.mesh.clone();
        meshes["cactus2.1"].position.set(15, 0.02, 14);
        meshes["cactus2.1"].scale.set(0.9, 0.9, 0.9);
        meshes["cactus2.1"].rotation.set(0,2.,0);
        scene.add(meshes["cactus2.1"]);


        meshes["cactus2.2"] = models.cactus2.mesh.clone();
        meshes["cactus2.2"].position.set(-50, 0.02, -14);
        meshes["cactus2.2"].scale.set(0.9, 0.9, 0.9);
        meshes["cactus2.2"].rotation.set(0,2.,0);
        scene.add(meshes["cactus2.2"]);

        meshes["cactus2.3"] = models.cactus2.mesh.clone();
        meshes["cactus2.3"].position.set(70, 0.02, -30);
        meshes["cactus2.3"].scale.set(0.9, 0.9, 0.9);
        meshes["cactus2.3"].rotation.set(0,2.,0);
        scene.add(meshes["cactus2.3"]);

        meshes["cactus2.4"] = models.cactus2.mesh.clone();
        meshes["cactus2.4"].position.set(100, 0.02, 80);
        meshes["cactus2.4"].scale.set(0.9, 0.9, 0.9);
        meshes["cactus2.4"].rotation.set(0,3,0);
        scene.add(meshes["cactus2.4"]);

        meshes["caja.1"] = models.caja.mesh.clone();
        meshes["caja.1"].scale.set(0.3,0.3,0.3);
        meshes["caja.1"].position.set(63, 2, 92);

        meshes["carro.1"] = models.carro.mesh.clone();
        meshes["carro.1"].position.set(10, 1.5, -25);
        meshes["carro.1"].scale.set(2, 2, 2);
        meshes["carro.1"].rotation.set(0,0.785398,0);
        scene.add(meshes["carro.1"]);



        let ammo1BB = {
          coll: new THREE.Box3(),
          item: meshes["caja.1"],
          consumed: false,
          arriba: true
        };
        scene.add(ammo1BB.item);
        ammo1BB.coll.setFromObject(meshes["caja.1"]);
        items["ammo1BB"] = ammo1BB;

        meshes["caja.2"] = models.caja.mesh.clone();
        meshes["caja.2"].scale.set(0.3,0.3,0.3);
        meshes["caja.2"].position.set(-44, 2, 57);
        let ammo2BB = {
          coll: new THREE.Box3(),
          item: meshes["caja.2"],
          consumed: false,
          arriba: true
        };
        scene.add(ammo2BB.item);
        ammo2BB.coll.setFromObject(meshes["caja.2"]);
        items["ammo2BB"] = ammo2BB;

        meshes["caja.3"] = models.caja.mesh.clone();
        meshes["caja.3"].scale.set(0.3,0.3,0.3);
        meshes["caja.3"].position.set(112, 2, -64);
        let life1BB = {
          coll: new THREE.Box3(),
          item: meshes["caja.3"],
          consumed: false,
          arriba: true
        };
        scene.add(life1BB.item);
        life1BB.coll.setFromObject(meshes["caja.3"]);
        items["life1BB"] = life1BB;

        meshes["caja.4"] = models.caja.mesh.clone();
        meshes["caja.4"].scale.set(0.3,0.3,0.3);
        meshes["caja.4"].position.set(-91, 2, -71);
        let life2BB = {
          coll: new THREE.Box3(),
          item: meshes["caja.4"],
          consumed: false,
          arriba: true
        };
        scene.add(life2BB.item);
        life2BB.coll.setFromObject(meshes["caja.4"]);
        items["life2BB"] = life2BB;

        meshes["caja.5"] = models.caja.mesh.clone();
        meshes["caja.5"].scale.set(0.3,0.3,0.3);
        meshes["caja.5"].position.set(-167, 2, -10);
        let time1BB = {
          coll: new THREE.Box3(),
          item: meshes["caja.5"],
          consumed: false,
          arriba: true
        };
        scene.add(time1BB.item);
        time1BB.coll.setFromObject(meshes["caja.5"]);
        items["time1BB"] = time1BB;

        meshes["caja.6"] = models.caja.mesh.clone();
        meshes["caja.6"].scale.set(0.3,0.3,0.3);
        meshes["caja.6"].position.set(5, 2, -55);
        let bomba1BB = {
          coll: new THREE.Box3(),
          item: meshes["caja.6"],
          consumed: false,
          arriba: true
        };
        scene.add(bomba1BB.item);
        bomba1BB.coll.setFromObject(meshes["caja.6"]);
        items["bomba1BB"] = bomba1BB;
        

        let obj = models.zombie.mesh.clone();
        obj.position.set(-80, 0.01, 5);
        obj.scale.set(0.1, 0.1, 0.1);
        let zombie = {
          coll: new THREE.Box3(),
          item: obj,
          consumed: false,
          arriba: true
        };
        zombie.coll.setFromObject(zombie.item);
        zombies["zombie1BB"] = zombie;
        scene.add(zombies["zombie1BB"].item);

        let obj2 = models.zombie.mesh.clone();
        obj2.position.set(-109, 0.01, 73);
        obj2.scale.set(0.1, 0.1, 0.1);
        let zombie2 = {
          coll: new THREE.Box3(),
          item: obj2,
          consumed: false,
          arriba: true
        };
        zombie2.coll.setFromObject(zombie2.item);
        zombies["zombie2BB"] = zombie2;
        scene.add(zombies["zombie2BB"].item);

        let obj3 = models.zombie.mesh.clone();
        obj3.position.set(-5, 0.01, 96);
        obj3.scale.set(0.1, 0.1, 0.1);
        let zombie3 = {
          coll: new THREE.Box3(),
          item: obj3,
          consumed: false,
          arriba: true
        };
        zombie3.coll.setFromObject(zombie3.item);
        zombies["zombie3BB"] = zombie3;
        scene.add(zombies["zombie3BB"].item);

        let obj4 = models.zombie.mesh.clone();
        obj4.position.set(29, 0.01, 31);
        obj4.scale.set(0.1, 0.1, 0.1);
        let zombie4 = {
          coll: new THREE.Box3(),
          item: obj4,
          consumed: false,
          arriba: true
        };
        zombie4.coll.setFromObject(zombie4.item);
        zombies["zombie4BB"] = zombie4;
        scene.add(zombies["zombie4BB"].item);

        let obj5 = models.zombie.mesh.clone();
        obj5.position.set(-26, 0.01, -7);
        obj5.scale.set(0.1, 0.1, 0.1);
        let zombie5 = {
          coll: new THREE.Box3(),
          item: obj5,
          consumed: false,
          arriba: true
        };
        zombie5.coll.setFromObject(zombie5.item);
        zombies["zombie5BB"] = zombie5;
        scene.add(zombies["zombie5BB"].item);

        let obj6 = models.zombie.mesh.clone();
        obj6.position.set(3, 0.01, -67);
        obj6.scale.set(0.1, 0.1, 0.1);
        let zombie6 = {
          coll: new THREE.Box3(),
          item: obj6,
          consumed: false,
          arriba: true
        };
        zombie6.coll.setFromObject(zombie6.item);
        zombies["zombie6BB"] = zombie6;
        scene.add(zombies["zombie6BB"].item);

        let obj7 = models.zombie.mesh.clone();
        obj7.position.set(62, 0.01, -84);
        obj7.scale.set(0.1, 0.1, 0.1);
        let zombie7 = {
          coll: new THREE.Box3(),
          item: obj7,
          consumed: false,
          arriba: true
        };
        zombie7.coll.setFromObject(zombie7.item);
        zombies["zombie7BB"] = zombie7;
        scene.add(zombies["zombie7BB"].item);

        let obj8 = models.zombie.mesh.clone();
        obj8.position.set(179, 0.01, -82);
        obj8.scale.set(0.1, 0.1, 0.1);
        let zombie8 = {
          coll: new THREE.Box3(),
          item: obj8,
          consumed: false,
          arriba: true
        };
        zombie8.coll.setFromObject(zombie8.item);
        zombies["zombie8BB"] = zombie8;
        scene.add(zombies["zombie8BB"].item);
        
      }

      function modelos(){

        for (var _key in models){
          (function(key){
            var loader = new GLTFLoader(loadingManager);
            loader.load(models[key].glb, function( mesh ) {
                mesh.scene.traverse(function(node){
                  if (node instanceof THREE.Mesh){
                    node.castShadow = true;
                    node.receiveShadow = true;
                  }
                });
                models[key].mesh = mesh.scene;
              });
          })(_key);
        }

        // Loaders
        
        const loaderGLTF7 = new GLTFLoader(loadingManager);
        loaderGLTF7.load(
          "Escopeta.glb",
          function (gltf7) {
            let obj7 = gltf7.scene;
            obj7.position.set(10, 5, 0);
            obj7.rotation.set(0, 10, 0);
            obj7.scale.set(2, 2, 2);
            gltf7.scene.traverse( function( nodeEscopeta ) {
              if ( nodeEscopeta.isMesh ) { nodeEscopeta.castShadow = true; }
            } );
            scene.add(obj7);
          }
        );

        const loaderGLTF8 = new GLTFLoader(loadingManager);
        loaderGLTF8.load(
          "Soldado.glb",
          function (gltf8) {
            player.model = gltf8.scene;
            player.model.position.set(80, 0.5, 0);
            player.model.rotation.set(0, 5, 0);
            player.model.scale.set(4.3, 4.3, 4.3);
            gltf8.scene.traverse( function( nodeSoldado ) {
              if ( nodeSoldado.isMesh ) { nodeSoldado.castShadow = true; }
            } );
            scene.add(player.model);
          }
        );
        
        player.bb = new THREE.Sphere(new THREE.Vector3(80, 0.5, 0),3);
        
      }

      function disparo(){
        for(var index = 0; index <player.bullets.length; index+=1){
          if(player.bullets[index]== undefined) continue;
          if(player.bullets[index].alive == false){
            player.bullets.splice(index,1);
            player.bulletscoll.splice(index,1);
            continue;
          }

          player.bullets[index].position.add(player.bullets[index].velocity);
          player.bulletscoll[index].center = player.bullets[index].position;
        }
        if(player.canShoot>0) player.canShoot -=1;
      }

      function teclao(){
        if(keyboard[87]){ // w
          camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
          camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x -= Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z -= Math.cos(camera.rotation.y) * player.speed;
          player.bb.center =  player.model.position;
          
        }
        if(keyboard[83]){ // s
          camera.position.x += Math.sin(camera.rotation.y) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y) * player.speed;
          player.bb.center =  player.model.position;
        }
        if(keyboard[65]){ // a
          camera.position.x += Math.sin(camera.rotation.y - Math.PI/2) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y - Math.PI/2) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y - Math.PI/2) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y - Math.PI/2) * player.speed;
          player.bb.center =  player.model.position;
        }
        if(keyboard[68]){ // d
          camera.position.x += Math.sin(camera.rotation.y + Math.PI/2) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y + Math.PI/2) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y + Math.PI/2) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y + Math.PI/2) * player.speed;
          player.bb.center =  player.model.position;
        }
        
        if(keyboard[37]){
          camera.rotation.y += player.turnspeed;
          player.model.rotation.y += player.turnspeed;
        }
        if(keyboard[39]){
          camera.rotation.y -= player.turnspeed;
          player.model.rotation.y -= player.turnspeed;
        }
        if(keyboard[38]){
          camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
          camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x -= Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z -= Math.cos(camera.rotation.y) * player.speed;
          player.bb.center =  player.model.position;
        }
        if(keyboard[40]){
          camera.position.x += Math.sin(camera.rotation.y) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y) * player.speed;
          player.bb.center =  player.model.position;
        }
        
        disparo();
        if(keyboard[32] && player.canShoot <=0 && player.ammo >0){
          var bullet = new THREE.Mesh(
            new THREE.SphereGeometry(0.2,8,8),
            new THREE.MeshBasicMaterial({color:0xffffff})
          );
          bullet.position.set(player.model.position.x,player.model.position.y+3,player.model.position.z);
          var bulletSphere = new THREE.Sphere(bullet.position,.2);
          bullet.velocity = new THREE.Vector3(
            -Math.sin(camera.rotation.y),
            0,
            -Math.cos(camera.rotation.y),
          );
          bulletSphere.velocity = new THREE.Vector3(
            -Math.sin(camera.rotation.y),
            0,
            -Math.cos(camera.rotation.y),
          );

          bullet.alive = true;
          bulletSphere.alive = true;
          setTimeout(function(){
            bullet.alive = false;
            bulletSphere.alive = false;
            scene.remove(bullet);
            bulletSphere = null;
          }, 2000);
          player.bullets.push(bullet);
          player.bulletscoll.push(bulletSphere);
          player.ammo -= 1;
          scene.add(bullet);
          player.canShoot = 25;
          gunshotSound.play();
        }
      }

      function animacionitems(){
        
        for (var _key in items){
          (function(key){
            if (items[key].item.position.y >= 4 && items[key].arriba == true){
              items[key].arriba = false;
            } 
            if (items[key].item.position.y <= 2 && items[key].arriba == false){
              items[key].arriba = true;
            }
            
            if(items[key].arriba == true){
              items[key].item.position.y += .02;
            } 
            if(items[key].arriba == false) {
              items[key].item.position.y -= .02;
            }
            
            items[key].item.rotation.y += 0.01;
          })(_key);
        }
      }

      function puntos(){
        let puntostiempo = tempo.remainingSeconds * 2;
        let puntosvida = player.life * 2;
        let puntosenemigos = player.enemigos * 100;
        player.points = puntostiempo + puntosvida + puntosenemigos;
        console.log("obtuviste ", player.points, "pts");
      }
      

      function animate() {
        
        if( RESOURCES_LOADED == false ){
          requestAnimationFrame(animate);
            
          loadingScreen.box.position.x -= 0.05;
          if( loadingScreen.box.position.x < -10 ) loadingScreen.box.position.x = 10;
          loadingScreen.box.position.y = Math.sin(loadingScreen.box.position.x);
          
          renderer.render(loadingScreen.scene, loadingScreen.camera);
          return; // Stop the function here.
        }
        timerhud.textContent = "Timer: " + tempo.remainingSeconds;
        vidahud.textContent = "Vida: " + player.life;
        municionhud.textContent = "Municion: " + player.ammo;
        enemigoshud.textContent = "Enemigos restantes: " + (8 - player.enemigos);
        if(pause){
          document.getElementById("mainNav").hidden = false;
          document.getElementById("hud").hidden = true;
        } else{
          document.getElementById("mainNav").hidden = true;
          document.getElementById("hud").hidden = false;
        }
        if(victoria){
          document.getElementById("gameOver").hidden = false;
          document.getElementById("puntajefinal").textContent = "Puntaje obtenido " + player.points + " pts";
          document.getElementById("gameovertext").textContent = "VICTORIA";
          document.getElementById("hud").hidden = true; 
        } 
        if(gameover){
          document.getElementById("gameOver").hidden = false;
          document.getElementById("puntajefinal").textContent = "Puntaje obtenido " + player.points + " pts";
          document.getElementById("gameovertext").textContent = "DERROTA";
          document.getElementById("hud").hidden = true; 
        } 
        if(pause == false && victoria == false && gameover == false){
          estatushud.textContent = ""
        }
        
        document.onkeydown = function (e){
          if(e.keyCode === 80 && (tempo.remainingSeconds != 0) && gameover == false && victoria == false){
            if(pause == true) {
              
              tempo.start();
              pause = false;
            } else {
              console.log("en pausa"); 
              tempo.pause();
              pause = true;
            };
          }
          if(e.keyCode === 88){
            console.log(player.model.position);
          }
          if(e.keyCode === 32 && player.ammo ==0){
            console.log("no tienes municion");
          }
          //console.log(e.keyCode);
        }

        requestAnimationFrame(animate);
        if(pause == false && gameover == false && victoria == false){
          if(player.life <= 0 || tempo.remainingSeconds == 0){
            gameover = true;
            console.log("game over");
            puntos();
            
          }
          if(player.enemigos === 8){
            console.log("Victoria");
            
            victoria = true;
            puntos();
            
          }

          animacionitems();
          checkCollisions();
          teclao();
        }
        
        renderer.render(scene, camera);
      }

      function keyDown(event){
        keyboard[event.keyCode] = true;
      }
      function keyUp(event){
        keyboard[event.keyCode] = false;
      }
      function pausa(){
        pause = false;
        tempo.start();
      }
      document.getElementById("botonpausa").addEventListener("click", pausa, false);
      
      window.addEventListener('keydown', keyDown);     
      window.addEventListener('keyup', keyUp);      
 
      window.onload = init;
      

    </script>
    
  </body>
</html>
