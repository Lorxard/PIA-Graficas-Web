<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proyecto</title>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import * as THREE from "./three.module.js";
      import { OrbitControls } from "./OrbitControls.js";
      import { GLTFLoader } from "./GLTFLoader.js";
      //import {FBXLoader } from './FBXLoader.js';
      import {FBXLoader} from 'https://cdn.jsdelivr.net/npm/three@0.118.1/examples/jsm/loaders/FBXLoader.js';
      import { STLLoader } from "./STLLoader.js";

      var scene, camera, renderer, _controls;
      var meshFloor;

      var keyboard = {};
      var player = {speed: 0.5, turnspeed: 0.02, model: null, canShoot: 0, bullets: [], ammo:10 , life: 100};

      var loadingScreen = {
        scene: new THREE.Scene(),
        camera: new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight, 1, 100
        ),
        box: new THREE.Mesh(
	  	    new THREE.BoxGeometry(0.5,0.5,0.5),
		      new THREE.MeshBasicMaterial({ color:0x4444ff })
	      )
      };
      var loadingManager = null;
      var RESOURCES_LOADED = false;

      
      function init(){

        // SCENE
        scene = new THREE.Scene();
        scene.background = new THREE.Color("#34495E");
        scene.fog = new THREE.Fog(0xffffff,0,500)

        camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight, 1, 1000
        );
        camera.rotation.y = Math.PI * .5;
        camera.position.set(80, 8, 0);

        // Set up the loading screen's scene.
        // It can be treated just like our main scene.
        loadingScreen.box.position.set(0,0,5);
        loadingScreen.camera.lookAt(loadingScreen.box.position);
        loadingScreen.scene.add(loadingScreen.box);
        
        // Create a loading manager to set RESOURCES_LOADED when appropriate.
        // Pass loadingManager to all resource loaders.
        loadingManager = new THREE.LoadingManager();
        
        loadingManager.onProgress = function(item, loaded, total){
          console.log(item, loaded, total);
        };
        
        loadingManager.onLoad = function(){
          console.log("loaded all resources");
          RESOURCES_LOADED = true;
        };

        const loader = new THREE.TextureLoader();
        loader.load("./Imagenes/blue_sky.jpg", function (texture) {
          scene.background = texture;
        });

        // RENDERER
        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lights
        const hemispherelight = new THREE.HemisphereLight(0xffffbb, 0x080820, 1);
        scene.add(hemispherelight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(10, 50, 200);
        directionalLight.castShadow = true;

        // Plane
        var texture = new THREE.TextureLoader().load( "./Imagenes/Tierra-de-desierto.jpg" );
        meshFloor = new THREE.Mesh(
          new THREE.PlaneGeometry(500, 300),
          new THREE.MeshPhongMaterial({ map: texture })
        );
        meshFloor.position.set(15, -0.5, 15);
        meshFloor.receiveShadow = true;
        meshFloor.rotateX(-Math.PI / 2);

        // Adding to scene
        scene.add( meshFloor, hemispherelight, directionalLight);

        //const cameraControl = new OrbitControls(camera, renderer.domElement);

        function checkCollisions() {
          
        }

        // Resize

        function resize() {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
          renderer.render(scene, camera);
        }
        window.addEventListener("resize", resize);

        // Loaders
        //Load Zombie
        const loaderGLTF = new GLTFLoader(loadingManager);
        loaderGLTF.load(
          "Zombie.glb",
          function (gltf) {
            let obj = gltf.scene;
            obj.position.set(-80, 0.01, 5);
            obj.scale.set(0.1, 0.1, 0.1);
            gltf.scene.traverse( function( nodeZombie ) {
              if ( nodeZombie.isMesh ) { nodeZombie.castShadow = true; }
            } );
            scene.add(obj);
          }
        );

        //Load Edificio1
        const loaderGLTF2 = new GLTFLoader(loadingManager);
        loaderGLTF2.load(
          "House.glb",
          function (gltf2) {
            let obj2 = gltf2.scene;
            obj2.position.set(60, 0.02, 60);
            obj2.scale.set(1.7, 1.7, 1.7);
            gltf2.scene.traverse( function( nodeHouse ) {
              if ( nodeHouse.isMesh ) { nodeHouse.castShadow = true; }
            } );
            scene.add(obj2);
          }
        );
        //Load Edificio2      
        const loaderGLTF3 = new GLTFLoader(loadingManager);
        loaderGLTF3.load(
          "House2.glb",
          function (gltf3) {
            let obj3 = gltf3.scene;
            obj3.position.set(60, 0.02, -60);
            obj3.scale.set(3.9, 3.9, 3.9);
            gltf3.scene.traverse( function( nodeHouse2 ) {
              if ( nodeHouse2.isMesh ) { nodeHouse2.castShadow = true; }
            } );
            scene.add(obj3);
          }
        );
        
        //Load Caja
        const loaderGLTF4 = new GLTFLoader(loadingManager);
        loaderGLTF4.load( 'wooden_box_free.glb', function( gltf4 ) {
          gltf4.scene.traverse( function( node ) {
            if ( node.isMesh ) { node.castShadow = true, node.scale.set(0.2,0.2,0.2), node.position.set(3, 0, 3);}
          } );
          scene.add( gltf4.scene );
        } );

        //Load Cactus
        const loaderGLTF5 = new GLTFLoader(loadingManager);
        loaderGLTF5.load(
          "Cactus.glb",
          function (gltf5) {
            let obj5 = gltf5.scene;
            obj5.position.set(10, 0.02, 7);
            obj5.scale.set(0.2, 0.2, 0.2);
            gltf5.scene.traverse( function( nodeCactus ) {
              if ( nodeCactus.isMesh ) { nodeCactus.castShadow = true; }
            } );
            scene.add(obj5);
          }
        );
        const loaderGLTF6 = new GLTFLoader(loadingManager);
        loaderGLTF6.load(
          "Cactus2.glb",
          function (gltf6) {
            let obj6 = gltf6.scene;
            obj6.position.set(15, 0.02, 14);
            obj6.scale.set(0.9, 0.9, 0.9);
            gltf6.scene.traverse( function( nodeCactus2 ) {
              if ( nodeCactus2.isMesh ) { nodeCactus2.castShadow = true; }
          } );
            scene.add(obj6);
          }
        );

        const loaderGLTF7 = new GLTFLoader(loadingManager);
        loaderGLTF7.load(
          "Escopeta.glb",
          function (gltf7) {
            let obj7 = gltf7.scene;
            obj7.position.set(10, 5, 0);
            obj7.rotation.set(0, 10, 0);
            obj7.scale.set(2, 2, 2);
            gltf7.scene.traverse( function( nodeEscopeta ) {
              if ( nodeEscopeta.isMesh ) { nodeEscopeta.castShadow = true; }
            } );
            scene.add(obj7);
          }
        );


        const loaderGLTF8 = new GLTFLoader(loadingManager);
        loaderGLTF8.load(
          "Soldado.glb",
          function (gltf8) {
            player.model = gltf8.scene;
            player.model.position.set(80, 0.5, 0);
            player.model.rotation.set(0, 5, 0);
            player.model.scale.set(4.3, 4.3, 4.3);
            gltf8.scene.traverse( function( nodeSoldado ) {
              if ( nodeSoldado.isMesh ) { nodeSoldado.castShadow = true; }
            } );
            scene.add(player.model);
          }
        );

        ////////////////
        /*
        const loaderGLTF9 = new GLTFLoader();
              loaderGLTF9.load( 'bank_from_old_west.glb', function( gltf9 ) {

        gltf9.scene.traverse( function( node ) {

            if ( node.isMesh ) { node.castShadow = true, node.scale.set(3.9, 3.9, 3.9), node.position.set (-101,8, 60);}

        } );

        scene.add( gltf9.scene );

        } );
        */


        const loaderGLTF9 = new GLTFLoader(loadingManager);
        loaderGLTF9.load(
          "bank_from_old_west.glb",
          function (gltf2) {
            let obj9 = gltf2.scene;
            obj9.rotation.y=600;
            obj9.position.set(90, 0.02, -40);
            obj9.scale.set(3.9, 3.9, 3.9);
            gltf2.scene.traverse( function( nodeHouse ) {
              if ( nodeHouse.isMesh ) { nodeHouse.castShadow = true; }
            } );
            scene.add(obj9);
          }
        );

        const loaderGLTF10 = new GLTFLoader(loadingManager);
        loaderGLTF10.load( 'west_building-freepoly.org.glb', function( gltf10 ) {
          gltf10.scene.traverse( function( node3 ) {
            if ( node3.isMesh ) { node3.castShadow = true, node3.scale.set(3.9, 3.9, 3.9), node3.position.set (100, 600, 0);}
          } );
          scene.add( gltf10.scene );
        } );
        const loaderGLTF11 = new GLTFLoader(loadingManager);
        loaderGLTF11.load(
          "House2.glb",
          function (gltf11) {
            let obj11 = gltf11.scene;
            obj11.position.set(-20, 0.02, -60);
            obj11.scale.set(3.9, 3.9, 3.9);
            gltf11.scene.traverse( function( node ) {
              if ( node.isMesh ) { node.castShadow = true; }
            } );
            scene.add(obj11);
          }
        );

        const loaderGLTF12 = new GLTFLoader(loadingManager);
        loaderGLTF12.load(
          "House.glb",
          function (gltf) {
            let obj12 = gltf.scene;
            obj12.position.set(-70, 0.02, 60);
            obj12.scale.set(1.7, 1.7, 1.7);
            gltf.scene.traverse( function( node ) {
              if ( node.isMesh ) { node.castShadow = true; }
            } );
            scene.add(obj12);
          }
        );

        const loaderGLTF13 = new GLTFLoader(loadingManager);
        loaderGLTF13.load(
          "House.glb",
          function (gltf) {
            let obj13 = gltf.scene;
            obj13.rotation.y=300;
            obj13.position.set(-60, 0.02, -60);
            obj13.scale.set(1.7, 1.7, 1.7);
            gltf.scene.traverse( function( node ) {
              if ( node.isMesh ) { node.castShadow = true; }
            } );
            scene.add(obj13);
          }
        );

        const loaderGLTF14 = new GLTFLoader(loadingManager);
        loaderGLTF14.load(
          "west_building-freepoly.org.glb",
          function (gltf2) {
            let obj14 = gltf2.scene;
            obj14.rotation.y=600;
            obj14.position.set(-10, 0.02, 60);
            obj14.scale.set(3.9, 3.9, 3.9);
            gltf2.scene.traverse( function( nodeHouse ) {
              if ( nodeHouse.isMesh ) { nodeHouse.castShadow = true; }
            } );
            scene.add(obj14);
          }
        );
            
        const loaderGLTF15 = new GLTFLoader(loadingManager);
        loaderGLTF15.load(
          "bank_from_old_west.glb",
          function (gltf2) {
            let obj15 = gltf2.scene;
            obj15.rotation.y=0;
            obj15.position.set(15, 0.02, 45);
            obj15.scale.set(3.9, 3.9, 3.9);
            gltf2.scene.traverse( function( nodeHouse ) {
              if ( nodeHouse.isMesh ) { nodeHouse.castShadow = true; }
            } );
            scene.add(obj15);
          }
        );

        const loaderGLTF16 = new GLTFLoader(loadingManager);
        loaderGLTF16.load(
          "bank_from_old_west.glb",
          function (gltf2) {
            let obj16 = gltf2.scene;
            obj16.rotation.y=600;
            obj16.position.set(-110, 0.02, -40);
            obj16.scale.set(3.9, 3.9, 3.9);
            gltf2.scene.traverse( function( nodeHouse ) {
              if ( nodeHouse.isMesh ) { nodeHouse.castShadow = true; }
            } );
            scene.add(obj16);
          }
        );

        /////
        /*
              const loaderFBX9 = new FBXLoader();
              loaderFBX9.load( "Warzombie F Pedroso.fbx",(fbx)=> {
                fbx.scale.setScalar(0.5);
                fbx.traverse(c=>{
                  c.castShadow=true;
                });
                scene.add(fbx);
              });
        */
        ///////////

        

        animate();
      }

      function disparo(){
        for(var index = 0; index <player.bullets.length; index+=1){
          if(player.bullets[index]== undefined) continue;
          if(player.bullets[index].alive == false){
            player.bullets.splice(index,1);
            continue;
          }

          player.bullets[index].position.add(player.bullets[index].velocity);
        }
        if(player.canShoot>0) player.canShoot -=1;
      }

      function teclao(){
        if(keyboard[87]){ // w
          camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
          camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x -= Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z -= Math.cos(camera.rotation.y) * player.speed;
        }
        if(keyboard[83]){ // s
          camera.position.x += Math.sin(camera.rotation.y) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y) * player.speed;
        }
        if(keyboard[65]){ // a
          camera.position.x += Math.sin(camera.rotation.y - Math.PI/2) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y - Math.PI/2) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y - Math.PI/2) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y - Math.PI/2) * player.speed;
        }
        if(keyboard[68]){ // d
          camera.position.x += Math.sin(camera.rotation.y + Math.PI/2) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y + Math.PI/2) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y + Math.PI/2) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y + Math.PI/2) * player.speed;
        }
        
        if(keyboard[37]){
          camera.rotation.y += player.turnspeed;
          player.model.rotation.y += player.turnspeed;
        }
        if(keyboard[39]){
          camera.rotation.y -= player.turnspeed;
          player.model.rotation.y -= player.turnspeed;
        }
        if(keyboard[38]){
          camera.position.x -= Math.sin(camera.rotation.y) * player.speed;
          camera.position.z -= Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x -= Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z -= Math.cos(camera.rotation.y) * player.speed;
        }
        if(keyboard[40]){
          camera.position.x += Math.sin(camera.rotation.y) * player.speed;
          camera.position.z += Math.cos(camera.rotation.y) * player.speed;
          player.model.position.x += Math.sin(camera.rotation.y) * player.speed;
          player.model.position.z += Math.cos(camera.rotation.y) * player.speed;
        }
        disparo();
        if(keyboard[32] && player.canShoot <=0 && player.ammo >0){
          var bullet = new THREE.Mesh(
            new THREE.SphereGeometry(0.2,8,8),
            new THREE.MeshBasicMaterial({color:0xffffff})
          );
          bullet.position.set(player.model.position.x,player.model.position.y,player.model.position.z);
          bullet.velocity = new THREE.Vector3(
            -Math.sin(camera.rotation.y),
            0,
            -Math.cos(camera.rotation.y),
          );

          bullet.alive = true;
          setTimeout(function(){
            bullet.alive = false;
            scene.remove(bullet);
          }, 2000);
          player.bullets.push(bullet);
          player.ammo -= 1;
          scene.add(bullet);
          player.canShoot = 15;
        }
      }

      function animate() {
        if (player.model != undefined) {
          //var relativeCameraOffset = new THREE.Vector3(10,4,0);
          //var cameraOffset = player.model.localToWorld (relativeCameraOffset);
          //camera.position.copy (cameraOffset);
          //camera.lookAt( player.model.position );
        }

        if( RESOURCES_LOADED == false ){
          requestAnimationFrame(animate);
          
          loadingScreen.box.position.x -= 0.05;
          if( loadingScreen.box.position.x < -10 ) loadingScreen.box.position.x = 10;
          loadingScreen.box.position.y = Math.sin(loadingScreen.box.position.x);
          
          renderer.render(loadingScreen.scene, loadingScreen.camera);
          return; // Stop the function here.
        }

        requestAnimationFrame(animate);

        teclao();

        renderer.render(scene, camera);

      }

      function keyDown(event){
        keyboard[event.keyCode] = true;
      }
      function keyUp(event){
        keyboard[event.keyCode] = false;
      }

      

      window.addEventListener('keydown', keyDown);     
      window.addEventListener('keyup', keyUp);      
 
      window.onload = init;
      

    </script>
    
  </body>
</html>
